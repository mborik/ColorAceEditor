/*
 * ColorAceEditor v0.2.1
 * online editor of color images for PMD 85 microcomputer
 * Copyright (c) 2014 Martin BÃ³rik
 */
function ColorAceEditor(a){if(a=a||{},!a.canvas||!$(a.canvas).is("canvas"))throw"ColorAceEditor: Canvas element not defined!";this.canvas=a.canvas,this.ctx=this.canvas.getContext("2d"),this.zoomFactor=a.zoom||1,this.showGrid=a.grid||!0,this.undoLevels=a.undo||10,this.editColor=0,this.editTool=0,this.editMode=2,this.contentWidth=0,this.contentHeight=0,this.pixel=ColorAceEditor.Pixelator(this),this.draw=ColorAceEditor.Drawing(this),this.scroller=new Scroller(this.pixel.render,{animating:!1,bouncing:!1,snapping:!1,locking:!1,zooming:!0,maxZoom:16,minZoom:1}),this.setDimensions=function(a,b){this.contentWidth=a,this.contentHeight=b,this.scroller.setDimensions(a-276,b,288,256)},this.translateCoords=function(a,b){var c=this.scroller.getValues(),d=$(this.canvas).offset(),e={};return c.left=Math.max(Math.floor(c.left/c.zoom),0)*c.zoom,c.top=Math.max(Math.floor(c.top/c.zoom),0)*c.zoom,a=a-d.left+c.left,b=b-d.top+c.top,e.x=Math.floor(a/c.zoom),e.y=Math.floor(b/c.zoom),e.column=Math.floor(e.x/6),e}}ColorAceEditor.Pixelator=function(a){var b={},c=0,d=0,e=0,f=[];return b.pal=[[null,null,0,0,0,0,0],[null,null,255,0,0,1,1],[null,null,0,0,255,2,2],[null,null,255,0,255,3,3],[null,null,0,255,0,0,0],[null,null,255,255,0,1,0],[null,null,0,255,255,2,0],[null,null,255,255,255,3,0]],b.surface=a.ctx.createImageData(72,256).data,b.attrs=a.ctx.createImageData(12,256).data,b.readPMD85vram=function(a){var c,d,e,f,g=0,h=0,i=256,j=0;if(16384==a.length)for(;i--;){for(c=0;48>c;++c)f=(192&(d=a[g+c]))>>6,e=(192&a[g+c+64*((i%2<<1)-1)])>>6,e=f|e|(f*e?0:4),b.surface[j++]=1&d?e:0,b.surface[j++]=2&d?e:0,b.surface[j++]=4&d?e:0,b.surface[j++]=8&d?e:0,b.surface[j++]=16&d?e:0,b.surface[j++]=32&d?e:0,b.attrs[h++]=f;g+=64}},b.savePMD85vram=function(){var c,d,e,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",g=[],h=a.ctx.createImageData(16,256).data,i=0,j=0,k="";for(c=0;16384>c;c++)e=c%3,h[c]=g[e]=48>c%64?(b.surface[j++]?1:0)|(b.surface[j++]?2:0)|(b.surface[j++]?4:0)|(b.surface[j++]?8:0)|(b.surface[j++]?16:0)|(b.surface[j++]?32:0)|b.attrs[i++]<<6:0,2==e&&(d=g[0]<<16|g[1]<<8|g[2],k+=f.charAt(d>>18)+f.charAt(d>>12&63)+f.charAt(d>>6&63)+f.charAt(63&d));return d=g[0]<<16,k+=f.charAt(d>>18)+f.charAt(d>>12&63)+"==",{BASE64:k,binary:h}},b.preparePixels=function(c){var d,e,f,g;for(d=0;8>d;d++)for(b.pal[d][0]=a.ctx.createImageData(c,c),f=b.pal[d][0].data,b.pal[d][1]=a.ctx.createImageData(c,c),g=b.pal[d][1].data,e=0;c*c*4>e;e+=4)c>3&&e%(4*c)==4*(c-1)?(f[e+0]=b.pal[d][2]/1.33,f[e+1]=b.pal[d][3]/1.33,f[e+2]=b.pal[d][4]/1.33,g[e+0]=g[e+1]=g[e+2]=96-(255+b.pal[d][2]+b.pal[d][3]+b.pal[d][4])/16):c>3&&e>c*(c-1)*4?(f[e+0]=g[e+0]=b.pal[d][2]/2.66,f[e+1]=g[e+1]=b.pal[d][3]/2.66,f[e+2]=g[e+2]=b.pal[d][4]/2.66):(f[e+0]=g[e+0]=b.pal[d][2],f[e+1]=g[e+1]=b.pal[d][3],f[e+2]=g[e+2]=b.pal[d][4]),f[e+3]=g[e+3]=255},b.render=function(f,g,h){var i,j,k,l=0,m=0;for(d=Math.max(Math.floor(f/h),0)*h,e=Math.max(Math.floor(g/h),0)*h,h!=c&&(b.preparePixels(h),a.zoomFactor=c=h,a.canvas.width=Math.min(288*h,a.contentWidth),a.canvas.height=Math.min(256*h,a.contentHeight)),i=Math.max(Math.floor(g/h),0);256>i;i++){for(l=0,j=Math.max(Math.floor(f/h),0);288>j&&(k=h>3&&j%6==5&&a.showGrid?1:0,a.ctx.putImageData(b.pal[b.surface[288*i+j]][k],l,m),l+=h,!(l>=a.contentWidth));j++);if(m+=h,m>=a.contentHeight)break}},b.redrawRect=function(f,g,h,i,j){var k,l,m,n,o,p,q;for(q=g*c-e,k=g;g+i>k;k++){for(p=f*c-d,l=f;f+h>l&&(o=288*k+l,m=b.surface[o],j&&m&&(n=Math.floor(48*k+Math.floor(l/6)),m=n-48*((k%2<<1)-1),n=b.attrs[n],m=b.attrs[m],m=n|m|(n*m?0:4),b.surface[o]=m),o=c>3&&l%6==5&&a.showGrid?1:0,p>=0&&q>=0&&a.ctx.putImageData(b.pal[m][o],p,q),p+=c,!(p>=a.contentWidth));l++);if(q+=c,q>=a.contentHeight)break}},b.putPixel=function(f,g,h,i){var f,g,j,k,l,m,n;if(0>f||f>=288||0>g||g>=256||0>h||h>=4||0>i||i>=8)return!1;switch(j=Math.floor(f/6),m=Math.floor(48*g+j),n=m-48*((g%2<<1)-1),m>n&&(l=n,n=m,m=l),i?(k=i,b.attrs[m]=b.pal[k][5],b.attrs[n]=b.pal[k][6]):(l=b.attrs[m],k=b.attrs[n],k=l|k|(l*k?0:4)),l=288*g+f,h){case 0:k=b.surface[l]=0;break;case 1:b.surface[l]=k;break;case 2:k=b.surface[l]=b.surface[l]?0:k}i?b.redrawRect(6*j,(m-j)/48,6,2,!0):(l=c>3&&f%6==5&&a.showGrid?1:0,f=f*c-d,g=g*c-e,a.ctx.putImageData(b.pal[k][l],f,g))},b.doSnapshot=function(){var c=f.push([b.surface.subarray(0,b.surface.length),b.attr.subarray(0,b.attr.length)]);c>a.undoLevels&&snapshot.shift()},b.undo=function(){var a=f.pop();return a?(b.surface.set(a[0],0),b.attrs.set(a[1],0),!0):!1},b},ColorAceEditor.Drawing=function(a){var b={};return b.dot=function(b,c){a.pixel.putPixel(b,c,a.editMode,a.editColor)},b.line=function(b,c,d,e,f){for(var g,h=Math.abs(d-b),i=d>b?1:-1,j=Math.abs(e-c),k=e>c?1:-1,l=(h>j?h:-j)/2;;){if(f&&a.pixel.putPixel(b,c,a.editMode,a.editColor),f=!0,b===d&&c===e)break;g=l,g>-h&&(l-=j,b+=i),j>g&&(l+=h,c+=k)}},b};var editor=null,mousedown=0,notmoved=!1,lastPixelX=-1,lastPixelY=-1,resizeWrapper=function(){var a=$(window).width(),b=$(window).height();$("#wrapper").css({width:a+"px",height:b+"px"}),$("#leftPanel").css({height:b+"px"}),$("#mainPanel").css({height:b+"px"}),editor.setDimensions($("#mainPanel").width(),b)};$(document).ready(function(){editor=new ColorAceEditor({canvas:$("#myCanvas")[0],grid:!0,undo:20}),resizeWrapper(),$(window).resize(resizeWrapper),$(document).bind("contextmenu",function(a){return a.preventDefault(),!1}),$("#mainPanel").mousewheel(function(a,b){var c=editor.scroller;c.zoomTo(c.__zoomLevel+(0>b?-1:1),!1,a.pageX-c.__clientLeft,a.pageY-c.__clientTop)}),$("#mainPanel").mousedown(function(a){if(!a)var a=window.event;if(a.which&&a.which>1||a.button&&a.button>0)editor.scroller.doTouchStart([{pageX:a.pageX,pageY:a.pageY}],a.timeStamp),mousedown=2;else{var b=editor.translateCoords(a.pageX,a.pageY);lastPixelX=b.x,lastPixelY=b.y,mousedown=1}notmoved=!0}),$(document).mousemove(function(a){if(0!=mousedown){if(2==mousedown)editor.scroller.doTouchMove([{pageX:a.pageX,pageY:a.pageY}],a.timeStamp);else{var b=editor.translateCoords(a.pageX,a.pageY);(lastPixelX!=b.x||lastPixelY!=b.y)&&editor.draw.line(lastPixelX,lastPixelY,b.x,b.y,notmoved),lastPixelX=b.x,lastPixelY=b.y}notmoved=!1}}),$(document).mouseup(function(a){if(mousedown){if(!a)var a=window.event;if(a.which&&a.which>1||a.button&&a.button>0)editor.scroller.doTouchEnd(a.timeStamp);else{var b=editor.translateCoords(a.pageX,a.pageY);notmoved?editor.draw.dot(b.x,b.y):(lastPixelX!=b.x||lastPixelY!=b.y)&&editor.draw.line(lastPixelX,lastPixelY,b.x,b.y,!0)}lastPixelX=-1,lastPixelY=-1,notmoved=!1,mousedown=0}}),$("#clear-button").button({icons:{primary:"ui-icon-new"},text:!1}),$("#upload-button").button({icons:{primary:"ui-icon-load"}}).click(function(){return $("#upload-file:file").click(),!1}),$("#upload-file:file").change(function(){}),$("#save-button").button({icons:{primary:"ui-icon-save"}}).click(function(){var a,b=editor.pixel.savePMD85vram(),c=$("#save-data")[0],d=null;try{d=new Blob([b.binary],{type:"application/octet-stream"})}catch(e){console.error(e),d=null}if(!d)try{d=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder),d.append(b.binary),d=d.getBlob("application/octet-stream")}catch(e){console.error(e),d=null}if(d)try{if(a=(window.URL||window.webkitURL).createObjectURL(d),a!==a+"")throw"createObjectURL output "+a}catch(e){console.error(e),a="#"}else a="data:application/octet-stream;base64,"+b.BASE64;return c.href=a,c.click(),!1}),$("#tools").buttonset(),$("#tool0").button({icons:{primary:"ui-icon-select"},text:!1}),$("#tool1").button({icons:{primary:"ui-icon-select-grid"},text:!1}),$("#tool2").button({icons:{primary:"ui-icon-pencil"},text:!1}),$("#tool3").button({icons:{primary:"ui-icon-brush"},text:!1}),$("#tool4").button({icons:{primary:"ui-icon-fill"},text:!1}),$("#tool5").button({icons:{primary:"ui-icon-lines"},text:!1}),$("#tool6").button({icons:{primary:"ui-icon-ellipse"},text:!1}),$("#tool7").button({icons:{primary:"ui-icon-rectangle"},text:!1}),$("#colors").buttonset(),$("#drawing-mode").buttonset(),$("#colors > input:radio").click(function(){return editor.editColor=parseInt(this.value),!1}),$("#drawing-mode > input:radio").click(function(){return editor.editMode=parseInt(this.value),!1})});