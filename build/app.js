/*
 * ColorAceEditor v0.2.1
 * online editor of color images for PMD 85 microcomputer
 * Copyright (c) 2014 Martin BÃ³rik
 */
function ColorAceEditor(a){if(a=a||{},!a.canvas||!$(a.canvas).is("canvas"))throw"ColorAceEditor: Canvas element not defined!";this.canvas=a.canvas,this.ctx=this.canvas.getContext("2d"),this.zoomFactor=a.zoom||1,this.showGrid=a.grid||!0,this.undoLevels=a.undo||10,this.editColor=0,this.editTool=0,this.editMode=2,this.contentWidth=0,this.contentHeight=0,this.pixel=ColorAceEditor.Pixelator(this),this.draw=ColorAceEditor.Drawing(this),this.pixel.preparePixels(),this.scroller=new Scroller(this.pixel.render,{animating:!1,bouncing:!1,snapping:!1,locking:!1,zooming:!0,maxZoom:16,minZoom:1}),this.setDimensions=function(a,b){this.contentWidth=a,this.contentHeight=b,this.scroller.setDimensions(a-276,b,288,256)},this.translateCoords=function(a,b){var c=this.scroller.getValues(),d=$(this.canvas).offset(),e={};return c.left=Math.max(Math.floor(c.left/c.zoom),0)*c.zoom,c.top=Math.max(Math.floor(c.top/c.zoom),0)*c.zoom,a=a-d.left+c.left,b=b-d.top+c.top,e.x=Math.floor(a/c.zoom),e.y=Math.floor(b/c.zoom),e.column=Math.floor(e.x/6),e}}ColorAceEditor.Pixelator=function(a){var b,c,d,e,f,g,h={},i=0,j=0,k=0,l=[];return h.pal=[[0,0,0,0,0,0,0,0,0],[0,0,0,0,255,0,0,1,1],[0,0,0,0,0,0,255,2,2],[0,0,0,0,255,0,255,3,3],[0,0,0,0,0,255,0,0,0],[0,0,0,0,255,255,0,1,0],[0,0,0,0,0,255,255,2,0],[0,0,0,0,255,255,255,3,0]],h.surface=a.ctx.createImageData(72,256).data,h.attrs=a.ctx.createImageData(12,256).data,h.preparePixels=function(){var a,b,c,d,e,f=255<<24;for(a=0;8>a;a++)b=h.pal[a][4],c=h.pal[a][5],d=h.pal[a][6],e=Math.floor(96-(255+b+c+d)/16),h.pal[a][0]=f|d<<16|c<<8|b,b/=1.333,c/=1.333,d/=1.333,h.pal[a][1]=f|d<<16|c<<8|b,b/=2,c/=2,d/=2,h.pal[a][2]=f|d<<16|c<<8|b,h.pal[a][3]=f|e<<16|e<<8|e},h.readPMD85vram=function(a){var b,c,d,e,f=0,g=0,i=256,j=0;if(16384==a.length)for(;i--;){for(b=0;48>b;++b)e=(192&(c=a[f+b]))>>6,d=(192&a[f+b+64*((i%2<<1)-1)])>>6,d=e|d|(e*d?0:4),h.surface[j++]=1&c?d:0,h.surface[j++]=2&c?d:0,h.surface[j++]=4&c?d:0,h.surface[j++]=8&c?d:0,h.surface[j++]=16&c?d:0,h.surface[j++]=32&c?d:0,h.attrs[g++]=e;f+=64}},h.savePMD85vram=function(){var a,b,c,d,e,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",g=[],i=n.ctx.createImageData(16,256).data,j=0,k=0,l="",m="application/octet-stream";for(a=0;16384>a;a++)c=a%3,i[a]=g[c]=48>a%64?(h.surface[k++]?1:0)|(h.surface[k++]?2:0)|(h.surface[k++]?4:0)|(h.surface[k++]?8:0)|(h.surface[k++]?16:0)|(h.surface[k++]?32:0)|h.attrs[j++]<<6:0,2==c&&(b=g[0]<<16|g[1]<<8|g[2],l+=f.charAt(b>>18)+f.charAt(b>>12&63)+f.charAt(b>>6&63)+f.charAt(63&b));b=g[0]<<16,l+=f.charAt(b>>18)+f.charAt(b>>12&63)+"==";try{d=new Blob([i],{type:m})}catch(n){console.error(n);try{d=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder),d.append(i),d=d.getBlob(m)}catch(n){console.error(n),d=null}}if(d)try{e=(window.URL||window.webkitURL).createObjectURL(d)+""}catch(n){console.error(n),e=null}return e||"data:application/octet-stream;base64,"+g.BASE64},h.render=function(l,m,n){var o,p,q,r=0,s=0,t=0,u=Math.max(Math.floor(l/n),0),v=Math.max(Math.floor(m/n),0);for(j=u*n,k=v*n,n!=i&&(a.zoomFactor=i=n,c=a.canvas.width=Math.min(288*n,a.contentWidth),d=a.canvas.height=Math.min(256*n,a.contentHeight),b=a.ctx.createImageData(c,d),e=new ArrayBuffer(b.data.length),f=new Uint8ClampedArray(e),g=new Uint32Array(e)),o=v;256>o;o++){for(r=0,p=u,q=288*o+p;288>p&&(h.scalers[n](t+r,h.pal[h.surface[q]],p%6==5&&a.showGrid),r+=n,!(r>=c));p++,q++);if(s+=n,t+=n*c,s>=d)break}b.data.set(f),a.ctx.putImageData(b,0,0)},h.redrawRect=function(e,g,l,m,n){var o,p,q,r,s,t,u,v;for(u=g*i-k,v=u*c,o=g;g+m>o;o++){for(t=e*i-j,p=e,q=288*o+p;e+l>p&&(r=h.surface[q],n&&r&&(s=Math.floor(48*o+Math.floor(p/6)),r=s-48*((o%2<<1)-1),s=h.attrs[s],r=h.attrs[r],r=s|r|(s*r?0:4),h.surface[q]=r),t>=0&&u>=0&&h.scalers[i](u*c+t,h.pal[r],p%6==5&&a.showGrid),t+=i,!(t>=c));p++,q++);if(v+=i*c,u+=i,u>=d)break}b.data.set(f),a.ctx.putImageData(b,0,0)},h.putPixel=function(d,e,g,l){var d,e,m,n,o,p,q;if(0>d||d>=288||0>e||e>=256||0>g||g>=4||0>l||l>=8)return!1;switch(m=Math.floor(d/6),p=Math.floor(48*e+m),q=p-48*((e%2<<1)-1),p>q&&(o=q,q=p,p=o),l?(n=l,h.attrs[p]=h.pal[n][7],h.attrs[q]=h.pal[n][8]):(o=h.attrs[p],n=h.attrs[q],n=o|n|(o*n?0:4)),o=288*e+d,g){case 0:n=h.surface[o]=0;break;case 1:h.surface[o]=n;break;case 2:n=h.surface[o]=h.surface[o]?0:n}l?h.redrawRect(6*m,(p-m)/48,6,2,!0):(o=d%6==5&&a.showGrid,e=(e*i-k)*c,d=d*i-j,h.scalers[i](e+d,h.pal[n],o),b.data.set(f),a.ctx.putImageData(b,0,0))},h.scalers=[function(){},function(a,b){g[a]=b[0]},function(a,b){g[a++]=b[0],g[a]=b[0],a+=c-1,g[a++]=b[0],g[a]=b[0]},function(a,b,d){g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-2,g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-2,g[a++]=b[1],g[a++]=b[1],g[a]=b[d?3:1]},function(a,b,d){g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-3,g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[d?3:1],a+=c-3,g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-3,g[a++]=b[2],g[a++]=b[2],g[a++]=b[2],g[a]=b[d?3:2]},function(a,b,d){g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-4,g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-4,g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[d?3:1],a+=c-4,g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-4,g[a++]=b[2],g[a++]=b[2],g[a++]=b[2],g[a++]=b[2],g[a]=b[d?3:2]},function(a,b,d){g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-5,g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[d?3:1],a+=c-5,g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-5,g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[d?3:1],a+=c-5,g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a++]=b[0],g[a]=b[1],a+=c-5,g[a++]=b[2],g[a++]=b[2],g[a++]=b[2],g[a++]=b[2],g[a++]=b[2],g[a]=b[d?3:2]}],h.doSnapshot=function(){var b=l.push([h.surface.subarray(0,h.surface.length),h.attr.subarray(0,h.attr.length)]);b>a.undoLevels&&snapshot.shift()},h.undo=function(){var a=l.pop();return a?(h.surface.set(a[0],0),h.attrs.set(a[1],0),!0):!1},h},ColorAceEditor.Drawing=function(a){var b={};return b.dot=function(b,c){a.pixel.putPixel(b,c,a.editMode,a.editColor)},b.line=function(b,c,d,e,f){for(var g,h=Math.abs(d-b),i=d>b?1:-1,j=Math.abs(e-c),k=e>c?1:-1,l=(h>j?h:-j)/2;;){if(f&&a.pixel.putPixel(b,c,a.editMode,a.editColor),f=!0,b===d&&c===e)break;g=l,g>-h&&(l-=j,b+=i),j>g&&(l+=h,c+=k)}},b};var editor=null,mousedown=0,notmoved=!1,lastPixelX=-1,lastPixelY=-1,resizeWrapper=function(){var a=$(window).width(),b=$(window).height();$("#wrapper").css({width:a+"px",height:b+"px"}),$("#leftPanel").css({height:b+"px"}),$("#mainPanel").css({height:b+"px"}),editor.setDimensions($("#mainPanel").width(),b)};$(document).ready(function(){editor=new ColorAceEditor({canvas:$("#myCanvas")[0],grid:!0,undo:20}),resizeWrapper(),$(window).resize(resizeWrapper),$(document).bind("contextmenu",function(a){return a.preventDefault(),!1}),$("#mainPanel").mousewheel(function(a,b){var c=editor.scroller;c.zoomTo(c.__zoomLevel+(0>b?-1:1),!1,a.pageX-c.__clientLeft,a.pageY-c.__clientTop)}),$("#mainPanel").mousedown(function(a){if(!a)var a=window.event;if(a.which&&a.which>1||a.button&&a.button>0)editor.scroller.doTouchStart([{pageX:a.pageX,pageY:a.pageY}],a.timeStamp),mousedown=2;else{var b=editor.translateCoords(a.pageX,a.pageY);lastPixelX=b.x,lastPixelY=b.y,mousedown=1}notmoved=!0}),$(document).mousemove(function(a){if(0!=mousedown){if(2==mousedown)editor.scroller.doTouchMove([{pageX:a.pageX,pageY:a.pageY}],a.timeStamp);else{var b=editor.translateCoords(a.pageX,a.pageY);(lastPixelX!=b.x||lastPixelY!=b.y)&&editor.draw.line(lastPixelX,lastPixelY,b.x,b.y,notmoved),lastPixelX=b.x,lastPixelY=b.y}notmoved=!1}}),$(document).mouseup(function(a){if(mousedown){if(!a)var a=window.event;if(a.which&&a.which>1||a.button&&a.button>0)editor.scroller.doTouchEnd(a.timeStamp);else{var b=editor.translateCoords(a.pageX,a.pageY);notmoved?editor.draw.dot(b.x,b.y):(lastPixelX!=b.x||lastPixelY!=b.y)&&editor.draw.line(lastPixelX,lastPixelY,b.x,b.y,!0)}lastPixelX=-1,lastPixelY=-1,notmoved=!1,mousedown=0}}),$("#clear-button").button({icons:{primary:"ui-icon-new"},text:!1}).click(function(){return $(this).blur(),!1}),$("#upload-button").button({icons:{primary:"ui-icon-load"}}).click(function(){return $("#upload-file:file").click(),$(this).blur(),!1}),$("#upload-file:file").change(function(){var a=this.files[0],b=new window.FileReader;if(b&&a)try{b.onload=function(){var a=new Uint8Array(this.result);editor.pixel.readPMD85vram(a),editor.scroller.zoomTo(editor.zoomFactor)},b.readAsArrayBuffer(a)}catch(c){console.error(c)}}),$("#save-button").button({icons:{primary:"ui-icon-save"}}).click(function(){var a=editor.pixel.savePMD85vram(),b=$("#save-data")[0];return b.href=a,b.click(),$(this).blur(),!1}),$("#tools").buttonset(),$("#tool0").button({icons:{primary:"ui-icon-select"},text:!1}),$("#tool1").button({icons:{primary:"ui-icon-select-grid"},text:!1}),$("#tool2").button({icons:{primary:"ui-icon-pencil"},text:!1}),$("#tool3").button({icons:{primary:"ui-icon-brush"},text:!1}),$("#tool4").button({icons:{primary:"ui-icon-fill"},text:!1}),$("#tool5").button({icons:{primary:"ui-icon-lines"},text:!1}),$("#tool6").button({icons:{primary:"ui-icon-ellipse"},text:!1}),$("#tool7").button({icons:{primary:"ui-icon-rectangle"},text:!1}),$("#colors").buttonset(),$("#drawing-mode").buttonset(),$("#colors > input:radio").click(function(){return editor.editColor=parseInt(this.value),!1}),$("#drawing-mode > input:radio").click(function(){return editor.editMode=parseInt(this.value),!1})});