/*
 * ColorAceEditor v0.2.1
 * online editor of color images for PMD 85 microcomputer
 * Copyright (c) 2014 Martin BÃ³rik
 */
function ColorAceEditor(a){if(a=a||{},!a.canvas||!$(a.canvas).is("canvas"))throw"ColorAceEditor: Canvas element not defined!";this.canvas=a.canvas,this.ctx=this.canvas.getContext("2d"),this.statusBar=a.status,this.zoomFactor=a.zoom||1,this.showGrid=a.grid||!0,this.undoLevels=a.undo||10,this.editColor=0,this.editTool=2,this.editMode=2,this.contentWidth=0,this.contentHeight=0,this.pixel=ColorAceEditor.Pixelator(this),this.pixel.preparePixels(),this.draw=ColorAceEditor.Drawing(this),this.handler=ColorAceEditor.Handler(this),this.scroller=new Scroller(this.pixel.render,{animating:!1,bouncing:!1,snapping:!1,locking:!1,zooming:!0,maxZoom:16,minZoom:1}),this.setDimensions=function(a,b){this.contentWidth=a,this.contentHeight=b,this.scroller.setDimensions(a-276,b,288,256)},this.translateCoords=function(a,b){var c=this.scroller.getValues(),d=$(this.canvas).offset(),e={};return c.left=Math.max(Math.floor(c.left/c.zoom),0)*c.zoom,c.top=Math.max(Math.floor(c.top/c.zoom),0)*c.zoom,a=a-d.left+c.left,b=b-d.top+c.top,e.x=Math.floor(a/c.zoom),e.y=Math.floor(b/c.zoom),e.column=Math.floor(e.x/6),e},this.redrawStatusBar=function(a,b){var c=this.translateCoords(a,b),d=Math.max(0,Math.min(c.x,287)),e=Math.max(0,Math.min(c.y,255)),f=Math.max(0,Math.min(c.column,47)),g=(49152+64*e+f).toString(16).toUpperCase()+"h",h=100*this.zoomFactor,i=function(a,b){return a="    "+a,a.substr(a.length-b)};this.statusBar.text(i(h,4)+"%   X:"+i(d,3)+" Y:"+i(e,3)+"  C:"+i(f,2)+"   "+g)}}ColorAceEditor.Pixelator=function(a){var b,c,d,e,f,g,h={},i=0,j=0,k=0,l=[];return h.pal=[[0,0,0,0,0,0,0,0,0],[0,0,0,0,255,0,0,1,1],[0,0,0,0,0,0,255,2,2],[0,0,0,0,255,0,255,3,3],[0,0,0,0,0,255,0,0,0],[0,0,0,0,255,255,0,1,0],[0,0,0,0,0,255,255,2,0],[0,0,0,0,255,255,255,3,0]],h.surface=a.ctx.createImageData(72,256).data,h.attrs=a.ctx.createImageData(12,256).data,h.preparePixels=function(){var a,b,c,d,e,f=255<<24;for(a=0;8>a;a++)b=h.pal[a][4],c=h.pal[a][5],d=h.pal[a][6],e=Math.floor(96-(255+b+c+d)/16),h.pal[a][0]=f|d<<16|c<<8|b,b=b/1.6+32,c=c/1.6+32,d=d/1.6+32,h.pal[a][1]=f|d<<16|c<<8|b,b=b/2.4+16,c=c/2.4+16,d=d/2.4+16,h.pal[a][2]=f|d<<16|c<<8|b,h.pal[a][3]=f|e<<16|e<<8|e},h.readPMD85vram=function(a){var b,c,d,e,f=0,g=0,i=256,j=0;if(16384==a.length)for(;i--;){for(b=0;48>b;++b)e=(192&(c=a[f+b]))>>6,d=(192&a[f+b+64*((i%2<<1)-1)])>>6,d=e|d|(e*d?0:4),h.surface[j++]=1&c?d:0,h.surface[j++]=2&c?d:0,h.surface[j++]=4&c?d:0,h.surface[j++]=8&c?d:0,h.surface[j++]=16&c?d:0,h.surface[j++]=32&c?d:0,h.attrs[g++]=e;f+=64}},h.savePMD85vram=function(){var b,c,d,e,f,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=[],j=a.ctx.createImageData(16,256).data,k=0,l=0,m="",n="application/octet-stream";for(b=0;16384>b;b++)d=b%3,j[b]=i[d]=48>b%64?(h.surface[l++]?1:0)|(h.surface[l++]?2:0)|(h.surface[l++]?4:0)|(h.surface[l++]?8:0)|(h.surface[l++]?16:0)|(h.surface[l++]?32:0)|h.attrs[k++]<<6:0,2==d&&(c=i[0]<<16|i[1]<<8|i[2],m+=g.charAt(c>>18)+g.charAt(c>>12&63)+g.charAt(c>>6&63)+g.charAt(63&c));c=i[0]<<16,m+=g.charAt(c>>18)+g.charAt(c>>12&63)+"==";try{e=new Blob([j],{type:n})}catch(o){console.error(o);try{var p=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;p=new p,p.append(j),e=p.getBlob(n)}catch(q){console.error(q),e=null}}if(e)try{f=(window.URL||window.webkitURL).createObjectURL(e)+""}catch(o){console.error(o),f=null}return f||"data:application/octet-stream;base64,"+i.BASE64},h.isGrid=function(b){return a.showGrid&&b%6==5?3:0},h.render=function(l,m,n){var o,p,q,r,s=0,t=0,u=0,v=Math.max(Math.floor(l/n),0),w=Math.max(Math.floor(m/n),0);for(j=v*n,k=w*n,n!=i&&(a.zoomFactor=i=n,c=a.canvas.width=Math.min(288*n,a.contentWidth),d=a.canvas.height=Math.min(256*n,a.contentHeight),b=a.ctx.createImageData(c,d),e=new ArrayBuffer(b.data.length),f=new Uint8ClampedArray(e),g=new Uint32Array(e)),o=w,r=c-n;256>o;o++){for(s=0,p=v,q=288*o+p;288>p&&(h.scalers[n](u+s,h.pal[h.surface[q]],h.isGrid(p)),s+=n,!(s>=r));p++,q++);if(t+=n,u+=n*c,t>=d)break}b.data.set(f),a.ctx.putImageData(b,0,0)},h.redrawRect=function(e,g,l,m,n){var o,p,q,r,s,t,u,v,w,x,y;for(w=c-i,v=(u=g*i-k)*c,o=g;g+m>o;o++){for(t=e*i-j,p=e,q=288*o+p;e+l>p&&(r=h.surface[q],n&&r&&(s=Math.floor(48*o+Math.floor(p/6)),r=s+(1&o?-48:48),s=h.attrs[s],r=h.attrs[r],r=s|r|(s*r?0:4),h.surface[q]=r),t>=0&&u>=0&&(h.scalers[i](v+t,h.pal[r],h.isGrid(p)),void 0===x&&(x=t,y=u)),t+=i,!(t>=w));p++,q++);if(u+=i,v+=i*c,u>=d)break}b.data.set(f),void 0!==x&&(t-=x,u-=y,a.ctx.putImageData(b,0,0,x,y,t,u))},h.putPixel=function(d,e,g,l){var m,n,o,p,q;if(0>d||d>=288||0>e||e>=256||0>g||g>=4||0>l||l>=8)return!1;switch(m=Math.floor(d/6),p=Math.floor(48*e+m),q=p+(1&e?-48:48),p>q&&(o=q,q=p,p=o),l?(n=l,h.attrs[p]=h.pal[n][7],h.attrs[q]=h.pal[n][8]):(o=h.attrs[p],n=h.attrs[q],n=o|n|(o*n?0:4)),o=288*e+d,g){case 0:n=h.surface[o]=0;break;case 1:h.surface[o]=n;break;case 2:n=h.surface[o]=h.surface[o]?0:n}l?h.redrawRect(6*m,(p-m)/48,6,2,!0):(e=e*i-k,d=d*i-j,h.scalers[i](e*c+d,h.pal[n],h.isGrid(d)),b.data.set(f),a.ctx.putImageData(b,0,0,d,e,i,i))},h.doSnapshot=function(){var b=l.push([h.surface.subarray(0,h.surface.length),h.attr.subarray(0,h.attr.length)]);b>a.undoLevels&&snapshot.shift()},h.undo=function(){var a=l.pop();return a?(h.surface.set(a[0],0),h.attrs.set(a[1],0),!0):!1},h.scalers=[function(){},function(a,b){g[a]=b[0]},function(a,b){var d=b[0],e=c-1;g[a++]=d,g[a]=d,a+=e,g[a++]=d,g[a]=d},function(a,b,d){var e=b[0],f=c-2;g[a++]=e,g[a++]=e,g[a]=e,a+=f,g[a++]=e,g[a++]=e,g[a]=e,a+=f,g[a++]=e,g[a++]=e,g[a]=b[d]},function(a,b,d){var e=b[0],f=b[1|d],h=c-3;g[a++]=e,g[a++]=e,g[a++]=e,g[a]=e,a+=h,g[a++]=e,g[a++]=e,g[a++]=e,g[a]=e,a+=h,g[a++]=e,g[a++]=e,g[a++]=e,g[a]=e,a+=h,g[a++]=e,g[a++]=e,g[a++]=e,g[a]=f},null,function(a,b,d){var e,f=b[0],h=b[1],i=b[1|d],j=c-5;for(e=0;5>e;e++)g[a++]=f,g[a++]=f,g[a++]=f,g[a++]=f,g[a++]=f,g[a]=1&e?i:e%2?h:f,a+=j;g[a++]=f,g[a++]=h,g[a++]=f,g[a++]=h,g[a++]=f,g[a]=i},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[2],k=b[1|d],l=c-7;for(e=0;7>e;e++){for(f=0;7>f;f++)g[a++]=h;g[a]=1&e?k:i,a+=l}for(f=0;7>f;f++)g[a++]=j;g[a]=b[2|d]},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[2],k=b[1|d],l=c-9;for(e=0;9>e;e++){for(f=0;9>f;f++)g[a++]=h;g[a]=1&e?k:i,a+=l}for(f=0;9>f;f++)g[a++]=j;g[a]=b[2|d]},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[1|d],k=c-11;for(e=0;11>e;e++){for(f=0;11>f;f++)g[a++]=h;g[a]=1&e?j:i,a+=k}for(f=0;11>f;f++)g[a++]=11;g[a]=b[2|d]},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[1|d],k=c-13;for(e=0;13>e;e++){for(f=0;13>f;f++)g[a++]=h;g[a]=1&e?j:i,a+=k}for(f=0;13>f;f++)g[a++]=13;g[a]=b[2|d]},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[1|d],k=c-15;for(e=0;15>e;e++){for(f=0;15>f;f++)g[a++]=h;g[a]=1&e?j:i,a+=k}for(f=0;15>f;f++)g[a++]=15;g[a]=b[2|d]}],h},ColorAceEditor.Drawing=function(a){var b={};return b.dot=function(b,c){a.pixel.putPixel(b,c,a.editMode,a.editColor)},b.line=function(b,c,d,e,f){for(var g,h=Math.abs(d-b),i=d>b?1:-1,j=Math.abs(e-c),k=e>c?1:-1,l=(h>j?h:-j)/2;;){if(f&&a.pixel.putPixel(b,c,a.editMode,a.editColor),f=!0,b===d&&c===e)break;g=l,g>-h&&(l-=j,b+=i),j>g&&(l+=h,c+=k)}},b},ColorAceEditor.Handler=function(a){var b={},c=a.draw;return b.mouseDown=function(a){c.dot(a.x,a.y)},b.mouseMove=function(a){(a.lx!=a.x||a.ly!=a.y)&&c.line(a.lx,a.ly,a.x,a.y,a.mov)},b.mouseUp=function(a){a.mov?c.dot(a.x,a.y):(a.lx!=a.x||a.ly!=a.y)&&c.line(a.lx,a.ly,a.x,a.y,!0)},b};var editor=null,mousedown=0,notmoved=!1,lastPixelX=-1,lastPixelY=-1,resizeWrapper=function(){var a=$(window).width(),b=$(window).height();$("#wrapper").css({width:a+"px",height:b+"px"}),$("#leftPanel").css({height:b+"px"}),$("#mainPanel").css({height:b+"px"}),editor.setDimensions($("#mainPanel").width(),b)};$(document).ready(function(){editor=new ColorAceEditor({canvas:$("#myCanvas")[0],status:$("#statusBar"),grid:!0,undo:20}),resizeWrapper(),$(window).resize(resizeWrapper),$(document).bind("contextmenu",function(a){return a.preventDefault(),!1}),$("#mainPanel").mousewheel(function(a,b){var c=editor.scroller,d=editor.zoomFactor+(b=0>b?-1:1);1>d||d>16||(null===editor.pixel.scalers[d]&&(b*=2),c.zoomTo(c.__zoomLevel+b,!1,a.pageX-c.__clientLeft,a.pageY-c.__clientTop),editor.redrawStatusBar(a.pageX,a.pageY))}),$("#mainPanel").mousedown(function(a){if(a||(a=window.event),a.which&&a.which>1||a.button&&a.button>0)editor.scroller.doTouchStart([{pageX:a.pageX,pageY:a.pageY}],a.timeStamp),mousedown=2;else{var b=editor.translateCoords(a.pageX,a.pageY);editor.handler.mouseDown($.extend(b,{lx:lastPixelX,ly:lastPixelY,mov:!0})),lastPixelX=b.x,lastPixelY=b.y,mousedown=1}notmoved=!0}),$(document).mousemove(function(a){if(editor.redrawStatusBar(a.pageX,a.pageY),0!==mousedown){if(2==mousedown)editor.scroller.doTouchMove([{pageX:a.pageX,pageY:a.pageY}],a.timeStamp);else{var b=editor.translateCoords(a.pageX,a.pageY);editor.handler.mouseMove($.extend(b,{lx:lastPixelX,ly:lastPixelY,mov:notmoved})),lastPixelX=b.x,lastPixelY=b.y}notmoved=!1}}),$(document).mouseup(function(a){if(mousedown){if(a||(a=window.event),a.which&&a.which>1||a.button&&a.button>0)editor.scroller.doTouchEnd(a.timeStamp);else{var b=editor.translateCoords(a.pageX,a.pageY);editor.handler.mouseUp($.extend(b,{lx:lastPixelX,ly:lastPixelY,mov:notmoved}))}lastPixelX=-1,lastPixelY=-1,notmoved=!1,mousedown=0}}),$("#clear-button").button({icons:{primary:"ui-icon-new"},text:!1}).click(function(){return $(this).blur(),!1}),$("#upload-button").button({icons:{primary:"ui-icon-load"}}).click(function(){return $("#upload-file:file").click(),$(this).blur(),!1}),$("#upload-file:file").change(function(){var a=this.files[0],b=new window.FileReader;if(b&&a)try{b.onload=function(){var a=new Uint8Array(this.result);editor.pixel.readPMD85vram(a),editor.scroller.zoomTo(editor.zoomFactor)},b.readAsArrayBuffer(a)}catch(c){console.error(c)}}),$("#save-button").button({icons:{primary:"ui-icon-save"}}).click(function(){var a=editor.pixel.savePMD85vram(),b=$("#save-data")[0];return b.href=a,b.click(),$(this).blur(),!1}),$("#tools").buttonset(),$("#tool0").button({icons:{primary:"ui-icon-select"},text:!1}),$("#tool1").button({icons:{primary:"ui-icon-select-grid"},text:!1}),$("#tool2").button({icons:{primary:"ui-icon-pencil"},text:!1}),$("#tool3").button({icons:{primary:"ui-icon-brush"},text:!1}),$("#tool4").button({icons:{primary:"ui-icon-fill"},text:!1}),$("#tool5").button({icons:{primary:"ui-icon-lines"},text:!1}),$("#tool6").button({icons:{primary:"ui-icon-ellipse"},text:!1}),$("#tool7").button({icons:{primary:"ui-icon-rectangle"},text:!1}),$("#colors").buttonset(),$("#drawing-mode").buttonset(),$("#colors>input:radio").click(function(){return editor.editColor=parseInt(this.value),!1}),$("#tools>input:radio").click(function(){return editor.editTool=parseInt(this.value),!1}),$("#drawing-mode>input:radio").click(function(){return editor.editMode=parseInt(this.value),!1})});