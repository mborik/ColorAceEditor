/*
 * ColorAceEditor v0.2.1
 * online editor of color images for PMD 85 microcomputer
 * Copyright (c) 2019 Martin BÃ³rik
 */
function ColorAceEditor(a){if(a=a||{},!a.canvas||!$(a.canvas).is("canvas"))throw"ColorAceEditor: Canvas element not defined!";this.canvas=a.canvas,this.ctx=this.canvas.getContext("2d"),this.contentWidth=0,this.contentHeight=0,this.statusBar=a.status,this.zoomFactor=a.zoom||1,this.showGrid=a.grid||!0,this.undoLevels=a.undo||10,this.editColor=0,this.editTool=2,this.editMode=2,this.editSelect=0,this.editFilled=!1,this.pixel=ColorAceEditor.Pixelator(this),this.draw=ColorAceEditor.Drawing(this),this.handler=ColorAceEditor.Handler(this),this.uploader=ColorAceEditor.Uploader(this,a.upload),this.selection=ColorAceEditor.Selection(this),this.selectionCallback=function(a){for(var b=2;8>b;b++)$("#select"+b).button("option","disabled",!a)},this.pixel.preparePixels(),this.scroller=new Scroller(this.pixel.render,{animating:!1,bouncing:!1,snapping:!1,locking:!1,zooming:!0,maxZoom:16,minZoom:1}),this.setDimensions=function(a,b){this.contentWidth=a,this.contentHeight=b,this.scroller.setDimensions(a-276,b,288,256)},this.translateCoords=function(a,b){var c=this.scroller.getValues(),d=$(this.canvas).offset(),e={};return c.left=Math.max(Math.floor(c.left/c.zoom),0)*c.zoom,c.top=Math.max(Math.floor(c.top/c.zoom),0)*c.zoom,a=a-d.left+c.left,b=b-d.top+c.top,e.x=Math.floor(a/c.zoom),e.y=Math.floor(b/c.zoom),e.column=Math.floor(e.x/6),e},this.redrawStatusBar=function(a,b){var c=this.translateCoords(a,b),d=Math.max(0,Math.min(c.x,287)),e=Math.max(0,Math.min(c.y,255)),f=Math.max(0,Math.min(c.column,47)),g=(49152+64*e+f).toString(16).toUpperCase()+"h",h=100*this.zoomFactor,i=function(a,b){return a="    "+a,a.substr(a.length-b)};this.statusBar.text(i(h,4)+"%   X:"+i(d,3)+" Y:"+i(e,3)+"  C:"+i(f,2)+"   "+g)}}ColorAceEditor.Pixelator=function(a){var b,c,d,e,f,g,h={},i=0,j=0,k=0,l=[];return h.pal=[[0,0,0,0,0,0,0,0,0],[0,0,0,0,255,0,0,1,1],[0,0,0,0,0,0,255,2,2],[0,0,0,0,255,0,255,3,3],[0,0,0,0,0,255,0,0,0],[0,0,0,0,255,255,0,1,0],[0,0,0,0,0,255,255,2,0],[0,0,0,0,255,255,255,3,0]],h.surface=a.ctx.createImageData(72,256).data,h.attrs=a.ctx.createImageData(12,256).data,h.preparePixels=function(){var a,b,c,d,e,f=255<<24;for(a=0;8>a;a++)b=h.pal[a][4],c=h.pal[a][5],d=h.pal[a][6],e=Math.floor(96-(255+b+c+d)/16),h.pal[a][0]=f|d<<16|c<<8|b,b=b/1.6+32,c=c/1.6+32,d=d/1.6+32,h.pal[a][1]=f|d<<16|c<<8|b,b=b/2.4+16,c=c/2.4+16,d=d/2.4+16,h.pal[a][2]=f|d<<16|c<<8|b,h.pal[a][3]=f|e<<16|e<<8|e},h.readPMD85vram=function(a){var b,c,d,e,f=0,g=0,i=256,j=0;if(16384==a.length)for(;i--;){for(b=0;48>b;++b)e=(192&(c=a[f+b]))>>6,d=(192&a[f+b+64*((i%2<<1)-1)])>>6,d=e|d|(e*d?0:4),h.surface[j++]=1&c?d:0,h.surface[j++]=2&c?d:0,h.surface[j++]=4&c?d:0,h.surface[j++]=8&c?d:0,h.surface[j++]=16&c?d:0,h.surface[j++]=32&c?d:0,h.attrs[g++]=e;f+=64}},h.savePMD85vram=function(){var b,c,d,e,f,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=[],j=a.ctx.createImageData(16,256).data,k=0,l=0,m="",n="application/octet-stream";for(b=0;16384>b;b++)d=b%3,48>b%64?j[b]=i[d]=(h.surface[l++]?1:0)|(h.surface[l++]?2:0)|(h.surface[l++]?4:0)|(h.surface[l++]?8:0)|(h.surface[l++]?16:0)|(h.surface[l++]?32:0)|h.attrs[k++]<<6:j[b]=i[d]=0,2==d&&(c=i[0]<<16|i[1]<<8|i[2],m+=g.charAt(c>>18)+g.charAt(c>>12&63)+g.charAt(c>>6&63)+g.charAt(63&c));c=i[0]<<16,m+=g.charAt(c>>18)+g.charAt(c>>12&63)+"==";try{e=new Blob([j],{type:n})}catch(o){console.error(o);try{var p=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;p=new p,p.append(j),e=p.getBlob(n)}catch(q){console.error(q),e=null}}if(e)try{f=(window.URL||window.webkitURL).createObjectURL(e)+""}catch(o){console.error(o),f=null}return f||"data:application/octet-stream;base64,"+m},h.isGrid=function(b){return a.showGrid&&b%6==5?3:0},h.render=function(l,m,n){var o,p,q,r,s,t=0,u=0,v=0,w=Math.max(Math.floor(l/n),0),x=Math.max(Math.floor(m/n),0);for(j=w*n,k=x*n,n!=i&&(a.zoomFactor=i=n,c=a.canvas.width=Math.min(288*n,a.contentWidth),d=a.canvas.height=Math.min(256*n,a.contentHeight),b=a.ctx.createImageData(c,d),e=new ArrayBuffer(b.data.length),f=new Uint8ClampedArray(e),g=new Uint32Array(e)),o=x,s=c-n;256>o;o++){for(t=0,p=w,q=288*o+p;288>p&&(h.scalers[n](v+t,h.pal[h.surface[q]],h.isGrid(p)),(r=a.selection.testBoundsX(p,o))&&h.marqueeX(v+t+--r*(n-1),n,u),(r=a.selection.testBoundsY(p,o))&&h.marqueeY(v+t+--r*(n-1)*c,n,t),t+=n,!(t>s));p++,q++);if(u+=n,v+=n*c,u>=d)break}b.data.set(f),a.ctx.putImageData(b,0,0)},h.redrawRect=function(e,g,l,m,n){var o,p,q,r,s,t,u,v,w,x,y,z;for(x=c-i,w=(v=g*i-k)*c,o=g;g+m>o;o++){for(u=e*i-j,p=e,q=288*o+p;e+l>p&&(r=h.surface[q],n&&r&&(s=Math.floor(48*o+Math.floor(p/6)),r=s+(1&o?-48:48),s=h.attrs[s],r=h.attrs[r],r=s|r|(s*r?0:4),h.surface[q]=r),u>=0&&v>=0&&(h.scalers[i](w+u,h.pal[r],h.isGrid(p)),(t=a.selection.testBoundsX(p,o))&&h.marqueeX(w+u+--t*(i-1),i,v),(t=a.selection.testBoundsY(p,o))&&h.marqueeY(w+u+--t*(i-1)*c,i,u),void 0===y&&(y=u,z=v)),u+=i,!(u>x));p++,q++);if(v+=i,w+=i*c,v>=d)break}b.data.set(f),void 0!==y&&(u-=y,v-=z,a.ctx.putImageData(b,0,0,y,z,u,v))},h.redrawSelection=function(b){var c=a.selection.x1,d=a.selection.y1,e=a.selection.x2,f=a.selection.y2;b(a.selection),h.redrawRect(c,d,e,f,!1)},h.putPixel=function(d,e,g,l){var m,n,o,p,q;if(0>d||d>=288||0>e||e>=256||0>g||g>=4||0>l||l>=8)return!1;switch(m=Math.floor(d/6),p=Math.floor(48*e+m),q=p+(1&e?-48:48),p>q&&(o=q,q=p,p=o),l?(n=l,h.attrs[p]=h.pal[n][7],h.attrs[q]=h.pal[n][8]):(o=h.attrs[p],n=h.attrs[q],n=o|n|(o*n?0:4)),o=288*e+d,g){case 0:n=h.surface[o]=0;break;case 1:h.surface[o]=n;break;case 2:n=h.surface[o]=h.surface[o]?0:n}l?h.redrawRect(6*m,(p-m)/48,6,2,!0):(e=e*i-k,d=d*i-j,h.scalers[i](e*c+d,h.pal[n],h.isGrid(d)),b.data.set(f),a.ctx.putImageData(b,0,0,d,e,i,i))},h.doSnapshot=function(){var b=l.push([h.surface.subarray(0,h.surface.length),h.attr.subarray(0,h.attr.length)]);b>a.undoLevels&&snapshot.shift()},h.undo=function(){var a=l.pop();return a?(h.surface.set(a[0],0),h.attrs.set(a[1],0),!0):!1},h.marqueeX=function(a,b,d){var e,f=4294967295,h=3153936;for(e=0;b>e;e++,d++)g[a]=4&d?f:g[a]|h,a+=c},h.marqueeY=function(a,b,c){var d,e=4294967295,f=3153936;for(d=0;b>d;d++,c++,a++)g[a]=4&c?e:g[a]|f},h.scalers=[function(){},function(a,b){g[a]=b[0]},function(a,b){var d=b[0],e=c-1;g[a++]=d,g[a]=d,a+=e,g[a++]=d,g[a]=d},function(a,b,d){var e=b[0],f=c-2;g[a++]=e,g[a++]=e,g[a]=e,a+=f,g[a++]=e,g[a++]=e,g[a]=e,a+=f,g[a++]=e,g[a++]=e,g[a]=b[d]},function(a,b,d){var e=b[0],f=b[1|d],h=c-3;g[a++]=e,g[a++]=e,g[a++]=e,g[a]=e,a+=h,g[a++]=e,g[a++]=e,g[a++]=e,g[a]=e,a+=h,g[a++]=e,g[a++]=e,g[a++]=e,g[a]=e,a+=h,g[a++]=e,g[a++]=e,g[a++]=e,g[a]=f},null,function(a,b,d){var e,f=b[0],h=b[1],i=b[1|d],j=c-5;for(e=0;5>e;e++)g[a++]=f,g[a++]=f,g[a++]=f,g[a++]=f,g[a++]=f,g[a]=1&e?i:e%2?h:f,a+=j;g[a++]=f,g[a++]=h,g[a++]=f,g[a++]=h,g[a++]=f,g[a]=i},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[2],k=b[1|d],l=c-7;for(e=0;7>e;e++){for(f=0;7>f;f++)g[a++]=h;g[a]=1&e?k:i,a+=l}for(f=0;7>f;f++)g[a++]=j;g[a]=b[2|d]},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[2],k=b[1|d],l=c-9;for(e=0;9>e;e++){for(f=0;9>f;f++)g[a++]=h;g[a]=1&e?k:i,a+=l}for(f=0;9>f;f++)g[a++]=j;g[a]=b[2|d]},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[1|d],k=c-11;for(e=0;11>e;e++){for(f=0;11>f;f++)g[a++]=h;g[a]=1&e?j:i,a+=k}for(f=0;11>f;f++)g[a++]=11;g[a]=b[2|d]},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[1|d],k=c-13;for(e=0;13>e;e++){for(f=0;13>f;f++)g[a++]=h;g[a]=1&e?j:i,a+=k}for(f=0;13>f;f++)g[a++]=13;g[a]=b[2|d]},null,function(a,b,d){var e,f,h=b[0],i=b[1],j=b[1|d],k=c-15;for(e=0;15>e;e++){for(f=0;15>f;f++)g[a++]=h;g[a]=1&e?j:i,a+=k}for(f=0;15>f;f++)g[a++]=15;g[a]=b[2|d]}],h},ColorAceEditor.Drawing=function(){var a={};return a.dot=function(a,b){editor.pixel.putPixel(a,b,editor.editMode,editor.editColor)},a.line=function(a,b,c,d,e){for(var f,g=Math.abs(c-a),h=c>a?1:-1,i=Math.abs(d-b),j=d>b?1:-1,k=(g>i?g:-i)/2;;){if(e&&editor.pixel.putPixel(a,b,editor.editMode,editor.editColor),e=!0,a===c&&b===d)break;f=k,f>-g&&(k-=i,a+=h),i>f&&(k+=g,b+=j)}},a},ColorAceEditor.Selection=function(){var a,b={x0:0,y0:0,x1:0,y1:0,x2:0,y2:0,w:0,h:0};return b.set=function(c,d,e,f){return c>e&&(a=c,c=e,e=a),d>f&&(a=d,d=f,f=a),c>287&&(c=287),d>255&&(d=255),e>287&&(e=287),f>255&&(f=255),b.x1=c,b.y1=d,b.x2=e,b.y2=f,b.w=e-c+1,b.h=f-d+1,b},b.reset=function(a,c){return a=a||0,c=c||0,a>287&&(a=287),c>255&&(c=255),b.x0=a,b.y0=c,b.x1=a,b.y1=c,b.x2=a,b.y2=c,b.w=b.h=0,b},b.offsetBy=function(a,c){return b.x1+=a,b.y1+=c,b.x2+=a,b.y2+=c,b.x1>287||b.y1>255?b.reset():((b.x2>287||b.y2>255)&&(b.x2=287,b.y2=255,b.w=b.x2-b.x1+1,b.h=b.y2-b.y1+1),b.x0=b.x1,b.y0=b.y1,b)},b.unionWith=function(a){return typeof a!=typeof b?!1:(b.x1=Math.min(b.x1,a.x1),b.y1=Math.min(b.y1,a.y1),b.x2=Math.min(b.x2,a.x2),b.y2=Math.min(b.y2,a.y2),b.w=x2-x1+1,b.h=y2-y1+1,b)},b.nonEmpty=function(){return b.x1<b.x2&&b.y1<b.y2},b.testBoundsX=function(a,c){if(b.x1<b.x2&&b.y1<=c&&b.y2>=c){if(a==b.x1)return 1;if(a==b.x2)return 2}return 0},b.testBoundsY=function(a,c){if(b.y1<b.y2&&b.x1<=a&&b.x2>=a){if(c==b.y1)return 1;if(c==b.y2)return 2}return 0},arguments.length>0&&("object"==typeof arguments[0]?$.extend(b,arguments[0]):"number"==typeof arguments[0]&&4==arguments.length&&b.set(arguments[0],arguments[1],arguments[2],arguments[3])),b},ColorAceEditor.Handler=function(a){var b={};return b.mouseDown=function(a){switch(editor.editTool){case 0:editor.selection.reset(a.x,a.y),editor.scroller.zoomTo(editor.zoomFactor);break;case 1:editor.selection.reset(6*Math.floor(a.x/6),a.y),editor.scroller.zoomTo(editor.zoomFactor);break;case 2:editor.draw.dot(a.x,a.y);break;case 3:editor.draw.dot(a.x,a.y),editor.a80data||(editor.a80data=[]),editor.a80data.some(function(b){return b.x===a.x&&b.y===a.y})||editor.a80data.push({x:a.x,y:a.y})}},b.mouseMove=function(a){switch(editor.editTool){case 0:a.mov||editor.pixel.redrawSelection(function(b){b.set(b.x0,b.y0,a.x-1,a.y-1)});break;case 1:a.mov||editor.pixel.redrawSelection(function(b){b.set(b.x0,b.y0,6*Math.ceil(a.x/6)-1,a.y-1)});break;case 2:(a.lx!=a.x||a.ly!=a.y)&&editor.draw.line(a.lx,a.ly,a.x,a.y,a.mov)}},b.mouseUp=function(a){switch(editor.editTool){case 0:a.mov||editor.pixel.redrawSelection(function(){editor.selection.set(editor.selection.x0,editor.selection.y0,a.x-1,a.y-1)}),editor.selectionCallback(editor.selection.nonEmpty());break;case 1:a.mov||editor.pixel.redrawSelection(function(){editor.selection.set(editor.selection.x0,editor.selection.y0,6*Math.ceil(a.x/6)-1,a.y-1)}),editor.selectionCallback(editor.selection.nonEmpty());break;case 2:a.mov||a.lx==a.x&&a.ly==a.y||editor.draw.line(a.lx,a.ly,a.x,a.y,!0)}},b.selectFunction=function(){},b},ColorAceEditor.Uploader=function(a,b){if(!$(b).is("canvas"))throw"ColorAceEditor: Image render canvas element not defined!";var c=b.getContext("2d"),d=function(a,b){var d=c.getImageData(a,b,1,1).data;return Math.round((Math.round(299*d[0])+Math.round(587*d[1])+Math.round(114*d[2]))/1e3)};return function(e,f){if(e)try{var g=new window.FileReader;"string"==typeof e.type&&0===e.type.indexOf("image/")?(g.onload=function(){var e=new Image;e.onload=function(){(e.width>288||e.height>256)&&f({error:"invalid image dimensions"}),b.width=e.width,b.height=e.height,c.drawImage(e,0,0);for(var g=0;g<e.height;g++)for(var h=0;h<e.width;h++)a.pixel.surface[288*g+h]=d(h,g)?7:0;a.scroller.zoomTo(a.zoomFactor),e=null,f({success:!0})},e.src=this.result},g.readAsDataURL(e)):16384===e.size?(g.onload=function(){var b=new Uint8Array(this.result);a.pixel.readPMD85vram(b),a.scroller.zoomTo(a.zoomFactor),f({success:!0})},g.readAsArrayBuffer(e)):f({error:"not an image file or PMD-85 screen"})}catch(h){console.error(h)}}};var editor=null,mousedown=0,notmoved=!1,lastPixelX=-1,lastPixelY=-1,resizeWrapper=function(){var a=$(window).width(),b=$(window).height();$("#wrapper").css({width:a+"px",height:b+"px"}),$("#leftPanel").css({height:b+"px"}),$("#mainPanel").css({height:b+"px"}),editor.setDimensions($("#mainPanel").width(),b)};$(document).ready(function(){editor=new ColorAceEditor({canvas:$("#myCanvas")[0],upload:$("#upload-canvas")[0],status:$("#statusBar"),grid:!0,undo:20}),resizeWrapper(),$(window).resize(resizeWrapper),$(document).bind("contextmenu",function(a){return a.preventDefault(),!1}),$("#mainPanel").mousewheel(function(a,b){var c=editor.scroller,d=editor.zoomFactor+(b=0>b?-1:1);1>d||d>16||(null===editor.pixel.scalers[d]&&(b*=2),c.zoomTo(c.__zoomLevel+b,!1,a.pageX-c.__clientLeft,a.pageY-c.__clientTop),editor.redrawStatusBar(a.pageX,a.pageY))}),$("#mainPanel").mousedown(function(a){if(a||(a=window.event),a.which&&a.which>1||a.button&&a.button>0)editor.scroller.doTouchStart([{pageX:a.pageX,pageY:a.pageY}],a.timeStamp),mousedown=2;else{var b=editor.translateCoords(a.pageX,a.pageY);editor.handler.mouseDown($.extend(b,{lx:lastPixelX,ly:lastPixelY,mov:!0})),lastPixelX=b.x,lastPixelY=b.y,mousedown=1}notmoved=!0}),$(document).mousemove(function(a){if(editor.redrawStatusBar(a.pageX,a.pageY),0!==mousedown){if(2==mousedown)editor.scroller.doTouchMove([{pageX:a.pageX,pageY:a.pageY}],a.timeStamp);else{var b=editor.translateCoords(a.pageX,a.pageY);editor.handler.mouseMove($.extend(b,{lx:lastPixelX,ly:lastPixelY,mov:notmoved})),lastPixelX=b.x,lastPixelY=b.y}notmoved=!1}}),$(document).mouseup(function(a){if(mousedown){if(a||(a=window.event),a.which&&a.which>1||a.button&&a.button>0)editor.scroller.doTouchEnd(a.timeStamp);else{var b=editor.translateCoords(a.pageX,a.pageY);editor.handler.mouseUp($.extend(b,{lx:lastPixelX,ly:lastPixelY,mov:notmoved}))}lastPixelX=-1,lastPixelY=-1,notmoved=!1,mousedown=0}}),$("#clear-button").button({icons:{primary:"ui-icon-new"},text:!1}).click(function(){return $(this).blur(),!1}),$("#upload-button").button({icons:{primary:"ui-icon-load"}}).click(function(){return $("#upload-file:file").click(),$(this).blur(),!1}),$("#upload-file:file").change(function(){editor.uploader(this.files[0],function(a){$("#upload-file:file").val(""),"object"==typeof a&&a.error&&$('<div title="upload error">'+a.error+"</div>").dialog({modal:!0,buttons:["ok"]})})}),$("#save-button").button({icons:{primary:"ui-icon-save"}}).click(function(){var a=editor.pixel.savePMD85vram(),b=$("#save-data")[0];return b.href=a,b.click(),$(this).blur(),!1}),$("#tools").buttonset(),$("#colors").buttonset(),$("#drawing-mode").buttonset(),$("#select-func").buttonset(),$.each({tool0:"select",tool1:"select-grid",tool2:"pencil",tool3:"brush",tool4:"fill",tool5:"lines",tool6:"ellipse",tool7:"rectangle",select0:"select",select1:"resize",select2:"select-cut",select3:"select-move",select4:"select-copy",select5:"select-invert",select6:"select-flip-x",select7:"select-flip-y",fillmode:"fill"},function(a,b){$("#"+a).button({icons:{primary:"ui-icon-"+b},text:!1})}),$("#tool"+editor.editTool).click(),$("#mode"+editor.editMode).click(),$("#color"+editor.editColor).click(),$("#select"+editor.editSelect).click(),$("#filling-mode").hide(),$("#select-func").hide(),editor.selectionCallback(!1),$("#colors>input:radio").click(function(){return editor.editColor=parseInt(this.value),!1}),$("#tools>input:radio").click(function(){return editor.editTool=parseInt(this.value),editor.editTool>5?$("#filling-mode").show():($("#filling-mode").hide(),editor.editTool<2?($("#select-func").show(),$("#drawing-set").hide()):($("#select-func").hide(),$("#drawing-set").show())),!1}),$("#drawing-mode>input:radio").click(function(){return editor.editMode=parseInt(this.value),!1}),$("#select-func>input:radio").click(function(){return editor.editSelect=parseInt(this.value),editor.selection.nonEmpty()&&editor.editSelect>0&&(editor.handler.selectFunction(),(editor.editSelect<3||editor.editSelect>4)&&($("input#select0").click(),editor.editSelect=0)),!1}),$("#filling-mode>input:checkbox").change(function(){return editor.editFilled=this.checked,!1}),$(window).on("keydown",function(a){if(a.target&&/^a|input|button$/i.test(a.target.tagName))return!0;var b=a.which||a.charCode||a.keyCode;if(120===b&&editor.a80data instanceof Array){var c=editor.a80data.map(function(a){return"		db	"+a.x+", "+a.y}).join("\n");$("<textarea />").val(c).dialog({width:800,height:800,modal:!0}).css({fontFamily:"monospace",width:760,height:760}),c=null}else if(8===b&&editor.a80data instanceof Array){var d=editor.a80data.pop();d&&editor.draw.dot(d.x,d.y)}else{if(71!==b)return!0;editor.showGrid=!editor.showGrid,editor.scroller.zoomTo(editor.zoomFactor)}return a.preventDefault(),!1})});